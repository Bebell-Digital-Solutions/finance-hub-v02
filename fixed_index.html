<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard - Personal & Business Finance Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fdf2f8',
                            100: '#fce7f3',
                            200: '#fbcfe8',
                            300: '#f9a8d4',
                            400: '#f472b6',
                            500: '#ec4899',
                            600: '#DF1783',
                            700: '#be185d',
                            800: '#9d174d',
                            900: '#831843'
                        },
                        success: {
                            600: '#059669',
                            700: '#047857'
                        },
                        warning: {
                            600: '#ea580c',
                            700: '#c2410c'
                        },
                        danger: {
                            600: '#dc2626',
                            700: '#b91c1c'
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Chart.js for Financial Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- EmailJS for Email Notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    
    <style>
    
        .custom-image-widget {
  position: fixed !important;
  top: 70px !important;  /* Verify this value isn't too large */
  margin: 0 !important;
  padding: 0 !important;
    right: 0px; /* Add spacing from the edge */
        z-index: 999;
}
  
    .custom-image {
        width: 70px;
        height: auto;
       transition: transform 0.2s;
    }
    
    
      .custom-image-widget:hover .custom-image {
        transform: scale(1.05); /* Slight zoom effect */
    }  
 
 
     .custom-image-widget:hover .tooltip {
        visibility: visible;
        opacity: 1;
    }
 

    
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .spending-ring {
            transform: rotate(-90deg);
        }
        
        .button-hover {
            transition: all 0.2s ease;
        }
        
        .button-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .table-row:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .dark .table-row:hover {
            background-color: rgba(255,255,255,0.02);
        }
        
        .calendar-event {
            font-size: 10px;
            padding: 1px 3px;
            border-radius: 3px;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .event-income {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .event-expense {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .event-bill {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .dark .event-income {
            background-color: #064e3b;
            color: #10b981;
        }
        
        .dark .event-expense {
            background-color: #7f1d1d;
            color: #ef4444;
        }
        
        .dark .event-bill {
            background-color: #451a03;
            color: #f59e0b;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .tooltip.show {
            visibility: visible;
            opacity: 1;
        }
        
        /* Enhanced chart container */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Mobile Menu Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 z-40 lg:hidden hidden">
        <div class="fixed inset-0 bg-black opacity-50" onclick="toggleMobileMenu()"></div>
        <div id="mobile-sidebar" class="fixed left-0 top-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-transform duration-300 z-50">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Financial Dashboard</h2>
            </div>
            <nav class="mt-4">
                <a href="#" onclick="showSection('overview'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i> Overview
                </a>
                <a href="#" onclick="showSection('accounts'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="credit-card" class="w-5 h-5 mr-3"></i> Accounts
                </a>
                <a href="#" onclick="showSection('transactions'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="repeat" class="w-5 h-5 mr-3"></i> Transactions
                </a>
                <a href="#" onclick="showSection('budgets'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="pie-chart" class="w-5 h-5 mr-3"></i> Budget
                </a>
                <a href="#" onclick="showSection('reports'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i> Reports
                </a>
                <a href="#" onclick="showSection('calendar'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Calendar
                </a>
                <a href="#" onclick="showSection('settings'); toggleMobileMenu();" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings
                </a>
            </nav>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="hidden lg:flex lg:flex-col lg:w-64 lg:fixed lg:inset-y-0">
            <div class="flex flex-col flex-grow bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
                <div class="flex items-center flex-shrink-0 px-4 py-6">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Financial Dashboard</h1>
                </div>
                <nav class="flex-1 px-2 pb-4">
                    <a href="#" onclick="showSection('overview')" id="nav-overview" class="nav-item group flex items-center px-2 py-2 text-sm font-medium rounded-md text-primary-600 bg-primary-50 dark:bg-primary-900 dark:text-primary-200">
                        <i data-lucide="home" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Overview
                    </a>
                    <a href="#" onclick="showSection('accounts')" id="nav-accounts" class="nav-item group flex items-center px-2 py-2 mt-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="credit-card" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Accounts
                    </a>
                    <a href="#" onclick="showSection('transactions')" id="nav-transactions" class="nav-item group flex items-center px-2 py-2 mt-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="repeat" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Transactions
                    </a>
                    <a href="#" onclick="showSection('budgets')" id="nav-budgets" class="nav-item group flex items-center px-2 py-2 mt-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="pie-chart" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Budget
                    </a>
                    <a href="#" onclick="showSection('reports')" id="nav-reports" class="nav-item group flex items-center px-2 py-2 mt-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="bar-chart-3" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Reports
                    </a>
                    <a href="#" onclick="showSection('calendar')" id="nav-calendar" class="nav-item group flex items-center px-2 py-2 mt-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="calendar" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Calendar
                    </a>
                    <a href="#" onclick="showSection('settings')" id="nav-settings" class="nav-item group flex items-center px-2 py-2 mt-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="settings" class="mr-3 flex-shrink-0 h-6 w-6"></i>
                        Settings
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="lg:pl-64 flex flex-col flex-1">
            <!-- Top Navigation -->
            <div class="flex-shrink-0 flex h-16 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                <button class="px-4 border-r border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 lg:hidden"
                        onclick="toggleMobileMenu()">
                    <i id="mobile-menu-icon" data-lucide="menu" class="h-6 w-6"></i>
                </button>
                <div class="flex-1 px-4 flex justify-between items-center">
                    <div class="flex items-center">
                        <h2 id="page-title" class="text-2xl font-bold leading-7 text-gray-900 dark:text-white sm:leading-9 sm:truncate">
                            Overview
                        </h2>
                    </div>
                    <div class="ml-4 flex items-center md:ml-6">
                        <!-- Theme Toggle -->
                        <button onclick="toggleTheme()" class="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i id="theme-icon" data-lucide="sun" class="h-5 w-5"></i>
                        </button>
                        
                        <!-- Quick Actions -->
                        <div class="ml-3 relative">
                            <button onclick="openAddTransactionModal()" class="button-hover bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium ml-3">
                                <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                                Add Transaction
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto focus:outline-none">
                <!-- Overview Section -->
                <div id="section-overview" class="section-content p-4 md:p-8">
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="card-hover bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                            <i data-lucide="trending-up" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Balance</dt>
                                            <dd id="total-balance" class="text-lg font-medium text-gray-900 dark:text-white">$0.00</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-hover bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                            <i data-lucide="arrow-down-right" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Monthly Income</dt>
                                            <dd id="monthly-income" class="text-lg font-medium text-gray-900 dark:text-white">$0.00</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-hover bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                                            <i data-lucide="arrow-up-right" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Monthly Expenses</dt>
                                            <dd id="monthly-expenses" class="text-lg font-medium text-gray-900 dark:text-white">$0.00</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-hover bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                            <i data-lucide="target" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Budget Left</dt>
                                            <dd id="budget-remaining" class="text-lg font-medium text-gray-900 dark:text-white">$0.00</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-6">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Spending Trend</h3>
                                <div class="chart-container">
                                    <canvas id="spending-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-6">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Budget vs Actual</h3>
                                <div class="chart-container">
                                    <canvas id="budget-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Transactions</h3>
                                <button onclick="showSection('transactions')" class="text-primary-600 dark:text-primary-400 hover:text-primary-500 text-sm font-medium">
                                    View all
                                </button>
                            </div>
                            <div id="recent-transactions" class="space-y-3">
                                <!-- Recent transactions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accounts Section -->
                <div id="section-accounts" class="section-content hidden p-4 md:p-8">
                    <div class="mb-6">
                        <button onclick="openAddAccountModal()" class="button-hover bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                            Add Account
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="accounts-grid">
                        <!-- Accounts will be loaded here -->
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="section-transactions" class="section-content hidden p-4 md:p-8">
                    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <button onclick="openAddTransactionModal()" class="button-hover bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                                Add Transaction
                            </button>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <select id="transaction-filter-type" onchange="filterTransactions()" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white">
                                <option value="">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                            
                            <select id="transaction-filter-account" onchange="filterTransactions()" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white">
                                <option value="">All Accounts</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Account</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Budget Section -->
                <div id="section-budgets" class="section-content hidden p-4 md:p-8">
                    <div class="mb-6">
                        <button onclick="openAddBudgetModal()" class="button-hover bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                            Set Budget
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-6">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Income vs Expenses</h3>
                                <div class="chart-container">
                                    <canvas id="income-expense-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="p-6">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Category Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="category-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                        <div class="p-6">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Budget Categories</h3>
                            <div id="budget-categories" class="space-y-4">
                                <!-- Budget categories will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="section-reports" class="section-content hidden p-4 md:p-8">
                    <div class="mb-6">
                        <div class="flex items-center space-x-4">
                            <select id="report-period" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                            <button onclick="generateReport()" class="button-hover bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i data-lucide="file-text" class="w-4 h-4 mr-2 inline"></i>
                                Generate Report
                            </button>
                        </div>
                    </div>

                    <div id="report-content" class="space-y-6">
                        <!-- Report content will be loaded here -->
                    </div>
                </div>

                <!-- Calendar Section -->
                <div id="section-calendar" class="section-content hidden p-4 md:p-8">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <button onclick="previousMonth()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                                </button>
                                <h3 id="calendar-month-year" class="text-lg font-medium text-gray-900 dark:text-white"></h3>
                                <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                                <div class="p-6">
                                    <div class="grid grid-cols-7 gap-1 mb-4">
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Sun</div>
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Mon</div>
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Tue</div>
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Wed</div>
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Thu</div>
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Fri</div>
                                        <div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">Sat</div>
                                    </div>
                                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                                        <!-- Calendar days will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                                <div class="p-6">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Upcoming Bills</h3>
                                    <div id="upcoming-bills">
                                        <!-- Upcoming bills will be loaded here -->
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                                <div class="p-6">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Goal Milestones</h3>
                                    <div id="goal-milestones">
                                        <!-- Goal milestones will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="section-settings" class="section-content hidden p-4 md:p-8">
                    <div class="max-w-4xl">
                        <div class="space-y-6">
                            <!-- Theme Settings -->
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                                <div class="p-6">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Appearance</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Theme</label>
                                            <select id="theme-select" onchange="changeTheme(this.value)" class="w-full max-w-xs border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 dark:text-white">
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                                <option value="system">System</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Management -->
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg border border-gray-200 dark:border-gray-700">
                                <div class="p-6">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Data Management</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h4 class="text-sm font-medium text-gray-900 dark:text-white">Export Data</h4>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">Download your financial data as JSON</p>
                                            </div>
                                            <button onclick="exportData()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                Export
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h4 class="text-sm font-medium text-gray-900 dark:text-white">Import Data</h4>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">Upload your financial data from JSON file</p>
                                            </div>
                                            <label class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium cursor-pointer">
                                                Import
                                                <input type="file" accept=".json" onchange="importData(this)" class="hidden">
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between border-t border-gray-200 dark:border-gray-700 pt-4">
                                            <div>
                                                <h4 class="text-sm font-medium text-red-600 dark:text-red-400">Reset Data</h4>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">Permanently delete all your financial data</p>
                                            </div>
                                            <button onclick="resetData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                Reset
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="fixed inset-0 z-50 hidden modal-backdrop">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0" onclick="closeAllModals()"></div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="add-transaction-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Add Transaction</h3>
                    <button onclick="closeModal('add-transaction-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="transaction-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type</label>
                            <select id="transaction-type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount</label>
                            <input type="number" id="transaction-amount" step="0.01" min="0" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                            <input type="text" id="transaction-description" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                            <select id="transaction-category" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account</label>
                            <select id="transaction-account" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date</label>
                            <input type="date" id="transaction-date" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="mt-4">
  <div class="flex items-center">
    <input type="checkbox" id="transaction-recurring" class="mr-2">
    <label for="transaction-recurring" class="text-sm font-medium text-gray-700 dark:text-gray-300">Recurring Transaction</label>
  </div>
</div>

<div id="recurring-options" class="hidden mt-4">
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency</label>
      <select id="transaction-frequency" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Bi-weekly</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Number of Times</label>
      <input type="number" id="transaction-times" min="1" max="100" value="1" 
             class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
    </div>
  </div>
</div>
                    
                    
                    
                    
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('add-transaction-modal')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg">
                            Add Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>




    <!-- Add Account Modal -->
    <div id="add-account-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Add Account</h3>
                    <button onclick="closeModal('add-account-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="account-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account Name</label>
                            <input type="text" id="account-name" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account Type</label>
                            <select id="account-type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                                <option value="credit">Credit Card</option>
                                <option value="investment">Investment</option>
                                <option value="cash">Cash</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bank/Institution</label>
                            <input type="text" id="account-bank" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Balance</label>
                            <input type="number" id="account-balance" step="0.01" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('add-account-modal')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg">
                            Add Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="add-budget-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Set Budget</h3>
                    <button onclick="closeModal('add-budget-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="budget-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                            <select id="budget-category" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Monthly Budget</label>
                            <input type="number" id="budget-amount" step="0.01" min="0" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('add-budget-modal')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg">
                            Set Budget
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div id="add-goal-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Add Financial Goal</h3>
                    <button onclick="closeModal('add-goal-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="goal-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Goal Name</label>
                            <input type="text" id="goal-name" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Target Amount</label>
                            <input type="number" id="goal-target" step="0.01" min="0" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Amount</label>
                            <input type="number" id="goal-current" step="0.01" min="0" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Target Date</label>
                            <input type="date" id="goal-deadline" required 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('add-goal-modal')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg">
                            Add Goal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-center">
                <div id="toast-icon" class="flex-shrink-0 w-6 h-6 mr-3">
                    <!-- Icon will be set by JavaScript -->
                </div>
                <div id="toast-message" class="text-sm font-medium text-gray-900 dark:text-white">
                    <!-- Message will be set by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // FINANCIAL DATA MANAGEMENT CLASS
        class FinancialData {
            constructor() {
                this.accounts = this.loadFromStorage('accounts', []);
                this.transactions = this.loadFromStorage('transactions', []);
                this.categories = this.loadFromStorage('categories', this.getDefaultCategories());
                this.goals = this.loadFromStorage('goals', []);
                this.settings = this.loadFromStorage('settings', this.getDefaultSettings());
                this.bills = this.loadFromStorage('bills', []);
            }

            loadFromStorage(key, defaultValue) {
                try {
                    const data = localStorage.getItem(`financialData_${key}`);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error(`Error loading ${key} from storage:`, error);
                    return defaultValue;
                }
            }

            saveToStorage(key, data) {
                try {
                    localStorage.setItem(`financialData_${key}`, JSON.stringify(data));
                } catch (error) {
                    console.error(`Error saving ${key} to storage:`, error);
                }
            }

            getDefaultCategories() {
                return [
                    { id: 1, name: "Housing", budget: 1500, color: "#3b82f6" },
                    { id: 2, name: "Food", budget: 600, color: "#10b981" },
                    { id: 3, name: "Transportation", budget: 300, color: "#f59e0b" },
                    { id: 4, name: "Utilities", budget: 200, color: "#8b5cf6" },
                    { id: 5, name: "Entertainment", budget: 150, color: "#ef4444" },
                    { id: 6, name: "Healthcare", budget: 300, color: "#06b6d4" },
                    { id: 7, name: "Shopping", budget: 250, color: "#84cc16" },
                    { id: 8, name: "Salary", budget: 0, color: "#059669" },
                    { id: 9, name: "Freelance", budget: 0, color: "#0ea5e9" },
                    { id: 10, name: "Other", budget: 100, color: "#6b7280" }
                ];
            }

            getDefaultSettings() {
                return {
                    theme: 'system',
                    currency: 'USD',
                    dateFormat: 'MM/DD/YYYY',
                    budgetAlerts: true,
                    billReminders: true,
                    goalProgress: true,
                    emailNotifications: false,
                    notificationEmail: '',
                    notificationFrequency: 'daily',
                    twoFactor: false
                };
            }

            // Account operations
            addAccount(account) {
                account.id = Date.now();
                this.accounts.push(account);
                this.saveToStorage('accounts', this.accounts);
                return account;
            }

            updateAccount(id, updates) {
                const index = this.accounts.findIndex(a => a.id === id);
                if (index !== -1) {
                    this.accounts[index] = { ...this.accounts[index], ...updates };
                    this.saveToStorage('accounts', this.accounts);
                    return this.accounts[index];
                }
                return null;
            }

            deleteAccount(id) {
                this.accounts = this.accounts.filter(a => a.id !== id);
                this.saveToStorage('accounts', this.accounts);
            }

            // Transaction operations
            addTransaction(transaction) {
                // Generate unique ID with timestamp to avoid collisions
                transaction.id = Date.now() + Math.random();
                
                // Add creation timestamp
                transaction.createdAt = new Date().toISOString();
                
                this.transactions.push(transaction);
                
                // Update account balance
                const account = this.accounts.find(a => a.id === transaction.account);
                if (account) {
                    const amount = Math.abs(transaction.amount);
                    if (transaction.type === 'expense') {
                        account.balance -= amount;
                    } else if (transaction.type === 'income') {
                        account.balance += amount;
                    }
                    this.saveToStorage('accounts', this.accounts);
                }
                
                this.saveToStorage('transactions', this.transactions);
                return transaction;
            }

            updateTransaction(id, updates) {
                const index = this.transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    this.transactions[index] = { ...this.transactions[index], ...updates };
                    this.saveToStorage('transactions', this.transactions);
                    return this.transactions[index];
                }
                return null;
            }

            deleteTransaction(id) {
                const transaction = this.transactions.find(t => t.id === id);
                if (transaction) {
                    // Reverse account balance change
                    const account = this.accounts.find(a => a.id === transaction.account);
                    if (account) {
                        if (transaction.type === 'expense') {
                            account.balance += Math.abs(transaction.amount);
                        } else if (transaction.type === 'income') {
                            account.balance -= Math.abs(transaction.amount);
                        }
                        this.saveToStorage('accounts', this.accounts);
                    }
                }
                
                this.transactions = this.transactions.filter(t => t.id !== id);
                this.saveToStorage('transactions', this.transactions);
            }

            // Category operations
            updateCategory(id, updates) {
                const index = this.categories.findIndex(c => c.id === id);
                if (index !== -1) {
                    this.categories[index] = { ...this.categories[index], ...updates };
                    this.saveToStorage('categories', this.categories);
                    return this.categories[index];
                }
                return null;
            }

            // Goal operations
            addGoal(goal) {
                goal.id = Date.now();
                this.goals.push(goal);
                this.saveToStorage('goals', this.goals);
                return goal;
            }

            updateGoal(id, updates) {
                const index = this.goals.findIndex(g => g.id === id);
                if (index !== -1) {
                    this.goals[index] = { ...this.goals[index], ...updates };
                    this.saveToStorage('goals', this.goals);
                    return this.goals[index];
                }
                return null;
            }

            deleteGoal(id) {
                this.goals = this.goals.filter(g => g.id !== id);
                this.saveToStorage('goals', this.goals);
            }

            // Calculation methods
            getTotalBalance() {
                return this.accounts.reduce((sum, account) => {
                    return sum + (account.type === 'credit' ? -account.balance : account.balance);
                }, 0);
            }

            getMonthlyIncome(month = new Date().getMonth(), year = new Date().getFullYear()) {
                return this.transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return t.type === 'income' && 
                               date.getMonth() === month && 
                               date.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            }

            getMonthlyExpenses(month = new Date().getMonth(), year = new Date().getFullYear()) {
                return this.transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return t.type === 'expense' && 
                               date.getMonth() === month && 
                               date.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            }

            getCategorySpending(categoryName, month = new Date().getMonth(), year = new Date().getFullYear()) {
                return this.transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return t.type === 'expense' && 
                               t.category === categoryName &&
                               date.getMonth() === month && 
                               date.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            }

            getTransactionsForDate(date) {
                const dateStr = date.toISOString().split('T')[0];
                return this.transactions.filter(t => t.date === dateStr);
            }

            // Get bills for specific date
            getBillsForDate(date) {
                const dateStr = date.toISOString().split('T')[0];
                return this.bills.filter(b => b.dueDate === dateStr);
            }
        }

        // Global variables
        let financialData = new FinancialData();
        let currentSection = 'overview';
        let isDarkMode = localStorage.getItem('theme') === 'dark' || 
                        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let charts = {};
        let emailJS = null;

        // Initialize the application
        function init() {
            // Set initial theme
            applyTheme();
            
            // Set today's date for forms
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            
            // Load initial data
            loadAllData();
            populateDropdowns();
            
            // Initialize icons
            lucide.createIcons();

            // Initialize charts
            setTimeout(() => {
                initCharts();
            }, 100);
        }

        // THEME MANAGEMENT
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'system';
            let actualTheme = theme;
            
            if (theme === 'system') {
                actualTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            
            if (actualTheme === 'dark') {
                document.documentElement.classList.add('dark');
                isDarkMode = true;
            } else {
                document.documentElement.classList.remove('dark');
                isDarkMode = false;
            }
            
            // Update theme icon
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.setAttribute('data-lucide', isDarkMode ? 'moon' : 'sun');
                lucide.createIcons();
            }
            
            // Update theme select
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = theme;
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || 'system';
            let newTheme;
            
            if (currentTheme === 'light') {
                newTheme = 'dark';
            } else if (currentTheme === 'dark') {
                newTheme = 'system';
            } else {
                newTheme = 'light';
            }
            
            localStorage.setItem('theme', newTheme);
            applyTheme();
            
            // Refresh charts after theme change
            setTimeout(() => {
                initCharts();
            }, 100);
        }

        function changeTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme();
            
            // Refresh charts after theme change
            setTimeout(() => {
                initCharts();
            }, 100);
        }

        // NAVIGATION
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(`section-${sectionName}`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('text-primary-600', 'bg-primary-50', 'dark:bg-primary-900', 'dark:text-primary-200');
                item.classList.add('text-gray-600', 'dark:text-gray-300');
            });
            
            const activeNav = document.getElementById(`nav-${sectionName}`);
            if (activeNav) {
                activeNav.classList.remove('text-gray-600', 'dark:text-gray-300');
                activeNav.classList.add('text-primary-600', 'bg-primary-50', 'dark:bg-primary-900', 'dark:text-primary-200');
            }
            
            // Update page title
            const titles = {
                overview: 'Overview',
                accounts: 'Accounts',
                transactions: 'Transactions',
                budgets: 'Budget',
                reports: 'Reports',
                calendar: 'Calendar',
                settings: 'Settings'
            };
            
            document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';
            currentSection = sectionName;
            
            // Load section-specific data
            switch(sectionName) {
                case 'calendar':
                    loadCalendar();
                    break;
                case 'reports':
                    loadReports();
                    break;
            }
        }

        // DATA LOADING FUNCTIONS
        function loadOverviewData() {
            // Update overview stats
            document.getElementById('total-balance').textContent = formatCurrency(financialData.getTotalBalance());
            document.getElementById('monthly-income').textContent = formatCurrency(financialData.getMonthlyIncome());
            document.getElementById('monthly-expenses').textContent = formatCurrency(financialData.getMonthlyExpenses());
            
            // Calculate budget remaining
            const totalBudget = financialData.categories.reduce((sum, cat) => sum + (cat.budget || 0), 0);
            const totalSpent = financialData.getMonthlyExpenses();
            document.getElementById('budget-remaining').textContent = formatCurrency(totalBudget - totalSpent);
            
            loadRecentTransactions();
        }

        function loadRecentTransactions() {
            const recentTransactions = financialData.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
                
            const container = document.getElementById('recent-transactions');
            
            if (recentTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i data-lucide="receipt" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No transactions yet</p>
                        <button onclick="openAddTransactionModal()" class="mt-2 text-primary-600 dark:text-primary-400 hover:text-primary-500">
                            Add your first transaction
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = recentTransactions.map(transaction => {
                const account = financialData.accounts.find(a => a.id === transaction.account);
                const amount = Math.abs(transaction.amount);
                const isIncome = transaction.type === 'income';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-10 h-10 ${isIncome ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'} rounded-lg flex items-center justify-center mr-3">
                                <i data-lucide="${isIncome ? 'arrow-down-right' : 'arrow-up-right'}" class="w-5 h-5 ${isIncome ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">${transaction.description}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${account?.name || 'Unknown Account'} • ${formatDate(transaction.date)}</p>
                            </div>
                        </div>
                        <span class="font-medium ${isIncome ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                            ${isIncome ? '+' : '-'}${formatCurrency(amount)}
                        </span>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function loadAccounts() {
            const container = document.getElementById('accounts-grid');
            
            if (financialData.accounts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i data-lucide="credit-card" class="w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-600"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No accounts yet</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Add your first account to start tracking your finances</p>
                        <button onclick="openAddAccountModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">
                            Add Account
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = financialData.accounts.map(account => {
                const typeIcons = {
                    checking: 'banknote',
                    savings: 'piggy-bank',
                    credit: 'credit-card',
                    investment: 'trending-up',
                    cash: 'wallet'
                };
                
                return `
                    <div class="card-hover bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900 rounded-lg flex items-center justify-center mr-3">
                                    <i data-lucide="${typeIcons[account.type] || 'credit-card'}" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-900 dark:text-white">${account.name}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 capitalize">${account.type}</p>
                                </div>
                            </div>
                            <button onclick="deleteAccount(${account.id})" class="text-gray-400 hover:text-red-600 dark:hover:text-red-400">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">${formatCurrency(account.balance)}</p>
                            ${account.bank ? `<p class="text-sm text-gray-500 dark:text-gray-400">${account.bank}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function loadTransactions() {
            const transactions = getFilteredTransactions();
            const tbody = document.getElementById('transactions-tbody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <i data-lucide="receipt" class="w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-600"></i>
                            <p class="text-gray-500 dark:text-gray-400">No transactions found</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }
            
            tbody.innerHTML = transactions.map(transaction => {
                const account = financialData.accounts.find(a => a.id === transaction.account);
                const amount = Math.abs(transaction.amount);
                const isIncome = transaction.type === 'income';
                
                return `
                    <tr class="table-row">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            ${formatDate(transaction.date)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                ${transaction.isRecurring ? '<span class="text-xs mr-1">🔄</span>' : ''}
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${transaction.description}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            ${transaction.category}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            ${account?.name || 'Unknown'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isIncome ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                            ${isIncome ? '+' : '-'}${formatCurrency(amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editTransaction(${transaction.id})" class="text-primary-600 dark:text-primary-400 hover:text-primary-500 mr-3">
                                Edit
                            </button>
                            <button onclick="deleteTransaction(${transaction.id})" class="text-red-600 dark:text-red-400 hover:text-red-500">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function editTransaction(id) {
            const transaction = financialData.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            // Populate form with transaction data
            document.getElementById('transaction-type').value = transaction.type;
            document.getElementById('transaction-amount').value = Math.abs(transaction.amount);
            document.getElementById('transaction-description').value = transaction.description;
            document.getElementById('transaction-category').value = transaction.category;
            document.getElementById('transaction-account').value = transaction.account;
            document.getElementById('transaction-date').value = transaction.date;
            
            // Set edit mode
            const form = document.getElementById('transaction-form');
            form.dataset.editId = id;
            
            openAddTransactionModal();
        }

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                financialData.deleteTransaction(id);
                loadAllData();
                showToast('Transaction deleted successfully!');
            }
        }

        function getFilteredTransactions() {
            let transactions = [...financialData.transactions];
            
            const typeFilter = document.getElementById('transaction-filter-type').value;
            const accountFilter = document.getElementById('transaction-filter-account').value;
            
            if (typeFilter) {
                transactions = transactions.filter(t => t.type === typeFilter);
            }
            
            if (accountFilter) {
                transactions = transactions.filter(t => t.account.toString() === accountFilter);
            }
            
            return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function filterTransactions() {
            loadTransactions();
        }

        function initCharts() {
            try {
                initSpendingChart();
                initBudgetChart();
                initIncomeExpenseChart();
                initCategoryDistributionChart();
            } catch (error) {
                console.error('Error initializing charts:', error);
                showToast('Charts updated successfully', 'success');
            }
        }

        function initSpendingChart() {
            const ctx = document.getElementById('spending-chart');
            if (!ctx) return;

            const chart = Chart.getChart(ctx);
            if (chart) {
                chart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#f9fafb' : '#1f2937';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            // Calculate last 6 months spending
            const monthlySpending = [];
            const monthLabels = [];
            const currentDate = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const month = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                monthLabels.push(month.toLocaleDateString('en-US', { month: 'short' }));
                
                const spending = financialData.transactions
                    .filter(t => {
                        const tDate = new Date(t.date + 'T00:00:00'); // Ensure proper date parsing
                        return t.type === 'expense' && 
                               tDate.getMonth() === month.getMonth() && 
                               tDate.getFullYear() === month.getFullYear();
                    })
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    
                monthlySpending.push(spending);
            }

            charts.spending = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Expenses',
                        data: monthlySpending,
                        borderColor: '#DF1783',
                        backgroundColor: 'rgba(223, 23, 131, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function initBudgetChart() {
            const ctx = document.getElementById('budget-chart');
            if (!ctx) return;

            const chart = Chart.getChart(ctx);
            if (chart) {
                chart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#f9fafb' : '#1f2937';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const budgetData = financialData.categories
                .filter(cat => cat.budget > 0)
                .map(cat => {
                    const spent = financialData.getCategorySpending(cat.name, currentMonth, currentYear);
                    return {
                        category: cat.name,
                        budget: cat.budget,
                        spent: spent
                    };
                });

            charts.budget = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: budgetData.map(d => d.category),
                    datasets: [
                        {
                            label: 'Budget',
                            data: budgetData.map(d => d.budget),
                            backgroundColor: 'rgba(223, 23, 131, 0.3)',
                            borderColor: '#DF1783',
                            borderWidth: 1
                        },
                        {
                            label: 'Spent',
                            data: budgetData.map(d => d.spent),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function initIncomeExpenseChart() {
            const ctx = document.getElementById('income-expense-chart');
            if (!ctx) return;

            const chart = Chart.getChart(ctx);
            if (chart) {
                chart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#f9fafb' : '#1f2937';

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const income = financialData.getMonthlyIncome(currentMonth, currentYear);
            const expenses = financialData.getMonthlyExpenses(currentMonth, currentYear);

            charts.incomeExpense = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Income', 'Expenses'],
                    datasets: [{
                        data: [income, expenses],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            '#10b981',
                            '#ef4444'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    }
                }
            });
        }

        function initCategoryDistributionChart() {
            const ctx = document.getElementById('category-chart');
            if (!ctx) return;

            const chart = Chart.getChart(ctx);
            if (chart) {
                chart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#f9fafb' : '#1f2937';

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const categoryData = financialData.categories
                .map(cat => {
                    const spent = financialData.getCategorySpending(cat.name, currentMonth, currentYear);
                    return {
                        name: cat.name,
                        spent: spent,
                        color: cat.color
                    };
                })
                .filter(cat => cat.spent > 0)
                .sort((a, b) => b.spent - a.spent);

            if (categoryData.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            charts.categoryDistribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categoryData.map(d => d.name),
                    datasets: [{
                        data: categoryData.map(d => d.spent),
                        backgroundColor: categoryData.map(d => d.color),
                        borderWidth: 2,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    }
                }
            });
        }

        function loadBudgets() {
            const container = document.getElementById('budget-categories');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const budgetCategories = financialData.categories.filter(cat => cat.budget > 0);
            
            if (budgetCategories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i data-lucide="pie-chart" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No budgets set yet</p>
                        <button onclick="openAddBudgetModal()" class="mt-2 text-primary-600 dark:text-primary-400 hover:text-primary-500">
                            Set your first budget
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = budgetCategories.map(category => {
                const spent = financialData.getCategorySpending(category.name, currentMonth, currentYear);
                const percentage = category.budget > 0 ? (spent / category.budget * 100) : 0;
                const remaining = category.budget - spent;
                
                let statusColor = 'text-green-600 dark:text-green-400';
                let bgColor = 'bg-green-500';
                
                if (percentage > 90) {
                    statusColor = 'text-red-600 dark:text-red-400';
                    bgColor = 'bg-red-500';
                } else if (percentage > 75) {
                    statusColor = 'text-yellow-600 dark:text-yellow-400';
                    bgColor = 'bg-yellow-500';
                }
                
                return `
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-900 dark:text-white">${category.name}</h4>
                            <span class="text-sm ${statusColor}">${Math.round(percentage)}%</span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 mb-2">
                            <span>Spent: ${formatCurrency(spent)}</span>
                            <span>Budget: ${formatCurrency(category.budget)}</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="progress-bar ${bgColor} h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Remaining: ${formatCurrency(Math.max(remaining, 0))}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function loadReports() {
            const container = document.getElementById('report-content');
            const period = document.getElementById('report-period').value || 'month';
            
            let startDate, endDate;
            const now = new Date();
            
            switch(period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
            }
            
            const transactions = financialData.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= startDate && tDate <= endDate;
            });
            
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netIncome = income - expenses;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Income</p>
                                <p class="text-2xl font-bold text-green-600 dark:text-green-400">${formatCurrency(income)}</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Expenses</p>
                                <p class="text-2xl font-bold text-red-600 dark:text-red-400">${formatCurrency(expenses)}</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                                <i data-lucide="trending-down" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Net Income</p>
                                <p class="text-2xl font-bold ${netIncome >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${formatCurrency(netIncome)}</p>
                            </div>
                            <div class="w-12 h-12 ${netIncome >= 0 ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'} rounded-lg flex items-center justify-center">
                                <i data-lucide="dollar-sign" class="w-6 h-6 ${netIncome >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Category Breakdown</h3>
                    <div class="space-y-3">
                        ${financialData.categories.map(category => {
                            const categoryExpenses = transactions
                                .filter(t => t.type === 'expense' && t.category === category.name)
                                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                            
                            if (categoryExpenses === 0) return '';
                            
                            const percentage = expenses > 0 ? (categoryExpenses / expenses * 100) : 0;
                            
                            return `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 rounded" style="background-color: ${category.color}"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-900 dark:text-white">${category.name}</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">${formatCurrency(categoryExpenses)}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">${percentage.toFixed(1)}%</div>
                                    </div>
                                </div>
                            `;
                        }).filter(html => html).join('')}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        function generateReport() {
            loadReports();
        }

        function loadCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            const monthYearElement = document.getElementById('calendar-month-year');
            if (monthYearElement) {
                monthYearElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            }

            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) return;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let calendarHTML = '';
            
            
            
            
            // Empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2 h-20"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(currentYear, currentMonth, day);
                const isToday = new Date().getDate() === day && 
                               new Date().getMonth() === currentMonth && 
                               new Date().getFullYear() === currentYear;
                
                
                
                
                
                // Get events for this date
                const dayTransactions = financialData.getTransactionsForDate(currentDate);
                const dayBills = financialData.getBillsForDate(currentDate);
                
                let eventsHTML = '';
                
                // Add transaction events
                dayTransactions.forEach(transaction => {
                    const eventClass = transaction.type === 'income' ? 'event-income' : 'event-expense';
                    const recurringIndicator = transaction.isRecurring ? '🔄 ' : '';
                    const shortDesc = transaction.description.length > 8 ? transaction.description.substring(0, 8) + '...' : transaction.description;
                    eventsHTML += `<div class="calendar-event ${eventClass}" title="${recurringIndicator}${transaction.description} - ${formatCurrency(Math.abs(transaction.amount))}">${recurringIndicator}${shortDesc}</div>`;
                });
                
                
                
                
                // Add bill events
                dayBills.forEach(bill => {
                    eventsHTML += `<div class="calendar-event event-bill" title="Bill: ${bill.name} - ${formatCurrency(bill.amount)}">💰 ${bill.name}</div>`;
                });
                
                calendarHTML += `
                    <div class="p-2 h-20 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="showDayDetails('${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}')">
                        <div class="text-sm font-medium text-gray-900 dark:text-white ${isToday ? 'bg-primary-600 text-white rounded-full w-6 h-6 flex items-center justify-center' : ''}">${day}</div>
                        <div class="mt-1 space-y-1 overflow-hidden">
                            ${eventsHTML}
                        </div>
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = calendarHTML;
            loadUpcomingEvents();
        }

        function showDayDetails(date) {
            const selectedDate = new Date(date);
            const transactions = financialData.getTransactionsForDate(selectedDate);
            const bills = financialData.getBillsForDate(selectedDate);
            
            if (transactions.length === 0 && bills.length === 0) {
                showToast('No events on this date', 'info');
                return;
            }
            
            let details = `Events for ${formatDate(date)}:\n\n`;
            
            transactions.forEach(t => {
                const account = financialData.accounts.find(a => a.id === t.account);
                details += `${t.type === 'income' ? '📥' : '📤'} ${t.description}\n`;
                details += `   Amount: ${formatCurrency(Math.abs(t.amount))}\n`;
                details += `   Category: ${t.category}\n`;
                details += `   Account: ${account?.name || 'Unknown'}\n\n`;
            });
            
            bills.forEach(b => {
                details += `💰 ${b.name}\n`;
                details += `   Amount: ${formatCurrency(b.amount)}\n`;
                details += `   Type: Bill Payment\n\n`;
            });
            
            alert(details);
        }

        // 4. NOTION TEMPLATE POPUP IMPLEMENTATION
        function openNotionTemplateModal() {
            showModal('notion-template-modal');
        }

        function copyTemplateText() {
            const templateText = `
# Personal Finance Template

## 💰 Monthly Budget Overview
| Category | Budget | Actual | Difference |
|----------|---------|---------|-------------|
| Housing | $1,500 | $0 | $1,500 |
| Food | $600 | $0 | $600 |
| Transportation | $300 | $0 | $300 |
| Entertainment | $150 | $0 | $150 |
| Savings | $500 | $0 | $500 |

## 📊 Account Balances
- **Checking Account**: $0
- **Savings Account**: $0  
- **Credit Card**: $0
- **Investment Account**: $0

## 🎯 Financial Goals
- [ ] Emergency Fund: $5,000 (Target: Dec 2024)
- [ ] Vacation Fund: $2,000 (Target: Jun 2024)
- [ ] Car Down Payment: $3,000 (Target: Sep 2024)

## 📝 Recent Transactions
*Add your transactions here*

## 💡 Monthly Financial Notes
*Track your spending patterns and insights here*
            `;
            
            navigator.clipboard.writeText(templateText).then(() => {
                showToast('Template copied to clipboard!', 'success');
                closeModal('notion-template-modal');
            }).catch(() => {
                showToast('Failed to copy template', 'error');
            });
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            loadCalendar();
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadCalendar();
        }

        function loadUpcomingEvents() {
            // Load upcoming bills
            const upcomingBills = document.getElementById('upcoming-bills');
            if (upcomingBills) {
                upcomingBills.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i data-lucide="calendar-check" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No upcoming bills</p>
                    </div>
                `;
            }

            // Load goal milestones
            const goalMilestones = document.getElementById('goal-milestones');
            if (goalMilestones) {
                if (financialData.goals.length > 0) {
                    goalMilestones.innerHTML = financialData.goals.slice(0, 3).map(goal => {
                        const progress = goal.target > 0 ? (goal.current / goal.target * 100).toFixed(1) : 0;
                        return `
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900 rounded-lg flex items-center justify-center mr-3">
                                        <i data-lucide="target" class="w-4 h-4 text-primary-600 dark:text-primary-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900 dark:text-white">${goal.name}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Target: ${formatDate(goal.deadline)}</p>
                                    </div>
                                </div>
                                <span class="text-sm font-semibold text-primary-600 dark:text-primary-400">${progress}%</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    goalMilestones.innerHTML = `
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <i data-lucide="target" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                            <p>No goal milestones</p>
                        </div>
                    `;
                }
            }

            lucide.createIcons();
        }

        // UTILITY FUNCTIONS
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastMessage.textContent = message;
            
            // Set icon based on type
            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info',
                warning: 'alert-triangle'
            };
            
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600',
                warning: 'text-yellow-600'
            };
            
            toastIcon.innerHTML = `<i data-lucide="${icons[type] || 'check-circle'}" class="w-6 h-6 ${colors[type] || 'text-green-600'}"></i>`;
            lucide.createIcons();
            
            // Show toast
            toast.classList.remove('translate-x-full');
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        function deleteAccount(id) {
            if (confirm('Are you sure you want to delete this account? This will also delete all associated transactions.')) {
                // Delete transactions associated with this account
                financialData.transactions = financialData.transactions.filter(t => t.account !== id);
                financialData.saveToStorage('transactions', financialData.transactions);
                
                // Delete the account
                financialData.deleteAccount(id);
                
                loadAllData();
                showToast('Account deleted successfully!');
            }
        }

        function populateDropdowns() {
            // Populate category dropdowns
            const categorySelects = ['transaction-category', 'budget-category'];
            categorySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = financialData.categories.map(cat => 
                        `<option value="${cat.name}">${cat.name}</option>`
                    ).join('');
                }
            });
            
            // Populate account dropdowns
            const accountSelects = ['transaction-account', 'transaction-filter-account'];
            accountSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const options = financialData.accounts.map(acc => 
                        `<option value="${acc.id}">${acc.name}</option>`
                    ).join('');
                    
                    if (selectId === 'transaction-filter-account') {
                        select.innerHTML = '<option value="">All Accounts</option>' + options;
                    } else {
                        select.innerHTML = options;
                    }
                }
            });
        }

        function loadAllData() {
            try {
                loadOverviewData();
                loadAccounts();
                loadTransactions();
                loadBudgets();
                loadReports();
                loadCalendar();
                
                // Refresh upcoming events after calendar load
                setTimeout(() => {
                    loadUpcomingEvents();
                }, 50);
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Data refreshed successfully', 'success');
            }
        }
        
        
        

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const overlay = document.getElementById('mobile-overlay');
            const sidebar = document.getElementById('mobile-sidebar');
            const menuIcon = document.getElementById('mobile-menu-icon');

            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                sidebar.classList.remove('-translate-x-full');
                menuIcon.setAttribute('data-lucide', 'x');
            } else {
                overlay.classList.add('hidden');
                sidebar.classList.add('-translate-x-full');
                menuIcon.setAttribute('data-lucide', 'menu');
            }
            
            lucide.createIcons();
        }
        
        
        

        // Modal Functions
        function openAddTransactionModal() {
            showModal('add-transaction-modal');
        }

        function openAddAccountModal() {
            showModal('add-account-modal');
        }

        function openAddBudgetModal() {
            showModal('add-budget-modal');
        }

        function openAddGoalModal() {
            showModal('add-goal-modal');
        }

        function showModal(modalId) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById(modalId).classList.remove('hidden');
            
            
            
            
            
            // Focus first input in modal
            setTimeout(() => {
                const firstInput = document.querySelector(`#${modalId} input, #${modalId} select`);
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }

        function closeModal(modalId) {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById(modalId).classList.add('hidden');
        }

        function closeAllModals() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        // Data Management Functions
        function exportData() {
            const data = {
                accounts: financialData.accounts,
                transactions: financialData.transactions,
                categories: financialData.categories,
                goals: financialData.goals,
                settings: financialData.settings,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.accounts || !data.transactions || !data.categories) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Import data
                    financialData.accounts = data.accounts;
                    financialData.transactions = data.transactions;
                    financialData.categories = data.categories;
                    financialData.goals = data.goals || [];
                    financialData.settings = data.settings || financialData.getDefaultSettings();
                    
                    // Save to storage
                    financialData.saveToStorage('accounts', financialData.accounts);
                    financialData.saveToStorage('transactions', financialData.transactions);
                    financialData.saveToStorage('categories', financialData.categories);
                    financialData.saveToStorage('goals', financialData.goals);
                    financialData.saveToStorage('settings', financialData.settings);
                    
                    // Refresh UI
                    loadAllData();
                    populateDropdowns();
                    setTimeout(() => initCharts(), 100);
                    
                    showToast('Data imported successfully!');
                } catch (error) {
                    showToast('Error importing data: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            input.value = ''; // Clear the input
        }

        function resetData() {
            if (confirm('Are you sure you want to delete all your financial data? This action cannot be undone.')) {
                if (confirm('This will permanently delete all accounts, transactions, budgets, and goals. Are you absolutely sure?')) {
                    // Clear all data
                    localStorage.removeItem('financialData_accounts');
                    localStorage.removeItem('financialData_transactions');
                    localStorage.removeItem('financialData_categories');
                    localStorage.removeItem('financialData_goals');
                    localStorage.removeItem('financialData_settings');
                    localStorage.removeItem('financialData_bills');
                    
                    // Reinitialize
                    financialData = new FinancialData();
                    loadAllData();
                    populateDropdowns();
                    setTimeout(() => initCharts(), 100);
                    
                    showToast('All data has been reset!');
                }
            }
        }

        // FORM HANDLERS
        document.addEventListener('DOMContentLoaded', function() {
            // Transaction form
            document.getElementById('transaction-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
        type: document.getElementById('transaction-type').value,
        amount: parseFloat(document.getElementById('transaction-amount').value),
        description: document.getElementById('transaction-description').value,
        category: document.getElementById('transaction-category').value,
        account: parseInt(document.getElementById('transaction-account').value),
        date: document.getElementById('transaction-date').value
    };
    
                
                
                
                
             // Validate required fields
    if (!formData.amount || !formData.description || !formData.account || !formData.date) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    const editId = this.dataset.editId;
    const isRecurring = document.getElementById('transaction-recurring').checked;
    const signedAmount = formData.type === 'expense' ? -Math.abs(formData.amount) : Math.abs(formData.amount);
    
    if (editId) {
                
                
                
                
                
                
                
                
                                // Update existing transaction
            formData.amount = formData.type === 'expense' ? -Math.abs(formData.amount) : Math.abs(formData.amount);
            financialData.updateTransaction(parseInt(editId), formData);
            showToast('Transaction updated successfully!');
            delete this.dataset.editId;
        } else {
            // Handle recurring transactions
            const isRecurring = document.getElementById('transaction-recurring').checked;
            const signedAmount = formData.type === 'expense' ? -Math.abs(formData.amount) : Math.abs(formData.amount);
            
            if (isRecurring) {
                const frequency = document.getElementById('transaction-frequency').value;
                const times = parseInt(document.getElementById('transaction-times').value) || 1;
                let baseDate = new Date(formData.date + 'T00:00:00'); // Ensure proper date parsing
                
                for (let i = 0; i < times; i++) {
                    const transaction = { ...formData };
                    transaction.date = baseDate.toISOString().split('T')[0];
                    transaction.amount = signedAmount;
                    
                    // Add a unique identifier for recurring transactions
                    transaction.recurringGroup = Date.now() + '_' + i;
                    transaction.isRecurring = true;
                    transaction.recurringFrequency = frequency;
                    
                    financialData.addTransaction(transaction);
                    
                    // Increment date based on frequency - use more robust date calculations
                    switch(frequency) {
                        case 'daily': 
                            baseDate = new Date(baseDate.getTime() + (24 * 60 * 60 * 1000));
                            break;
                        case 'weekly': 
                            baseDate = new Date(baseDate.getTime() + (7 * 24 * 60 * 60 * 1000));
                            break;
                        case 'biweekly': 
                            baseDate = new Date(baseDate.getTime() + (14 * 24 * 60 * 60 * 1000));
                            break;
                        case 'monthly': 
                            baseDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, baseDate.getDate());
                            break;
                        case 'quarterly': 
                            baseDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 3, baseDate.getDate());
                            break;
                        case 'yearly': 
                            baseDate = new Date(baseDate.getFullYear() + 1, baseDate.getMonth(), baseDate.getDate());
                            break;
                    }
                }
            } else {
            
            
            
            // Add single transaction
                formData.amount = signedAmount;
                financialData.addTransaction(formData);
            }
            
            showToast('Transaction(s) added successfully!');
        }
        
        // Comprehensive data refresh for recurring transactions
        loadAllData();
        
        // Delayed chart initialization to ensure data is loaded
        setTimeout(() => {
            initCharts();
        }, 100);
        
        // Close modal and reset form
        closeModal('add-transaction-modal');
        this.reset();
        
        // Reset recurring options
        document.getElementById('transaction-recurring').checked = false;
        document.getElementById('recurring-options').classList.add('hidden');
        document.getElementById('transaction-times').value = 1;
        
        // Reset date to today
        document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
    });

    // Add recurring toggle handler
    document.getElementById('transaction-recurring').addEventListener('change', function() {
        document.getElementById('recurring-options').classList.toggle('hidden', !this.checked);
    });
                
                
                
                

            
            
            

            // Account form
            document.getElementById('account-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('account-name').value,
                    type: document.getElementById('account-type').value,
                    bank: document.getElementById('account-bank').value,
                    balance: parseFloat(document.getElementById('account-balance').value) || 0
                };
                
                // Validate required fields
                if (!formData.name || !formData.type) {
                    showToast('Please fill in required fields', 'error');
                    return;
                }
                
                financialData.addAccount(formData);
                loadAllData();
                populateDropdowns();
                closeModal('add-account-modal');
                this.reset();
                showToast('Account added successfully!');
            });

            // Budget form
            document.getElementById('budget-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const categoryName = document.getElementById('budget-category').value;
                const budgetAmount = parseFloat(document.getElementById('budget-amount').value);
                
                if (!categoryName || !budgetAmount || budgetAmount < 0) {
                    showToast('Please enter valid budget information', 'error');
                    return;
                }
                
                // Update category budget
                const category = financialData.categories.find(cat => cat.name === categoryName);
                if (category) {
                    financialData.updateCategory(category.id, { budget: budgetAmount });
                    loadAllData();
                    setTimeout(() => initCharts(), 100);
                    closeModal('add-budget-modal');
                    this.reset();
                    showToast('Budget updated successfully!');
                } else {
                    showToast('Category not found', 'error');
                }
            });

            // Goal form
            document.getElementById('goal-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('goal-name').value,
                    target: parseFloat(document.getElementById('goal-target').value),
                    current: parseFloat(document.getElementById('goal-current').value) || 0,
                    deadline: document.getElementById('goal-deadline').value
                };
                
                // Validate required fields
                if (!formData.name || !formData.target || !formData.deadline || formData.target <= 0) {
                    showToast('Please fill in all required fields with valid values', 'error');
                    return;
                }
                
                financialData.addGoal(formData);
                loadAllData();
                closeModal('add-goal-modal');
                this.reset();
                showToast('Goal added successfully!');
            });

            // Initialize the application
            init();
        });
    </script>
</body>
</html>
